<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>DigitMatchStars Pro™ - Secure Trading Bot | INSTANT TICK EXECUTION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        #log-area::-webkit-scrollbar { width: 4px; }
        #log-area::-webkit-scrollbar-thumb { background: #4ade80; border-radius: 2px; }
        #log-area::-webkit-scrollbar-track { background: #374151; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        @keyframes pulse-once { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.03); opacity: 0.9; } 100% { transform: scale(1); opacity: 1; } }
        .tick-flash { animation: pulse-once 0.1s ease-out; }
        .win-glow { animation: win-pulse 1s infinite; border-color: #10B981 !important; }
        @keyframes win-pulse { 0% { box-shadow: 0 0 5px #10B981; } 50% { box-shadow: 0 0 20px #10B981; } 100% { box-shadow: 0 0 5px #10B981; } }
    </style>
</head>
<body class="text-gray-100 min-h-screen pb-12">
    <nav class="bg-gray-900/50 backdrop-blur-md border-b border-gray-800 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-green-500 rounded-lg p-1">
                        <svg class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-400 to-emerald-500">DigitMatchStars Pro™</span>
                        <span id="status-badge" class="ml-3 inline-flex items-center px-3 py-1 text-sm font-medium rounded-full bg-red-600 text-white shadow-md">Disconnected</span>
                    </div>
                </div>
                <button onclick="logout()" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-gray-800/50 rounded-2xl p-4 border border-gray-700 shadow-xl">
                <p class="text-sm font-medium text-gray-400 mb-1">Balance</p>
                <p id="metricAccountBalance" class="text-2xl font-bold text-white">$0.00</p>
            </div>
            <div class="bg-gray-800/50 rounded-2xl p-4 border border-gray-700 shadow-xl">
                <p class="text-sm font-medium text-gray-400 mb-1">Total P/L</p>
                <p id="metricTotalProfit" class="text-2xl font-bold text-white">$0.00</p>
            </div>
            <div id="stat-wins-card" class="bg-gray-800/50 rounded-2xl p-4 border border-gray-700 shadow-xl">
                <p class="text-sm font-medium text-gray-400 mb-1">W / L</p>
                <p class="text-2xl font-bold text-white"><span id="metricWins" class="text-green-400">0</span> / <span id="metricLosses" class="text-red-400">0</span></p>
            </div>
            <div class="bg-gray-800/50 rounded-2xl p-4 border border-gray-700 shadow-xl">
                <p class="text-sm font-medium text-gray-400 mb-1">Price</p>
                <p id="price-display" class="text-2xl font-bold text-blue-400">0.0000</p>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-4 space-y-6">
            <section id="controls-section" class="bg-gray-800 rounded-3xl p-6 shadow-2xl border border-gray-700">
                <h2 class="text-lg font-bold mb-4">Bot Config</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Stake</label>
                            <input type="number" id="baseStake" value="1.00" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Target ($)</label>
                            <input type="number" id="takeProfit" value="10.00" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm outline-none">
                        </div>
                    </div>
                    <select id="marketSelect" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm">
                        <option value="R_100">Volatility 100 Index</option>
                        <option value="R_75">Volatility 75 Index</option>
                    </select>
                    <select id="strategySelect" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm">
                        <option value="DIGITMATCH">Digit Match (800%+ Payout)</option>
                        <option value="DIGITDIFF">Digit Diff (Safe 9.9%)</option>
                    </select>
                    <button id="mainActionButton" onclick="toggleBot()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl uppercase tracking-widest">
                        Start Bot
                    </button>
                </div>
            </section>
        </div>

        <div class="lg:col-span-8">
            <div class="bg-gray-800 rounded-3xl shadow-2xl border border-gray-700 overflow-hidden flex flex-col h-[400px]">
                <div class="p-4 border-b border-gray-700 bg-gray-800/80 flex justify-between items-center">
                    <h3 class="font-bold text-sm uppercase tracking-widest text-gray-300">Transaction Logs</h3>
                </div>
                <div id="log-area" class="flex-grow overflow-y-auto p-4 font-mono text-xs space-y-1 bg-black/20">
                    <div class="text-yellow-500 italic">[SYSTEM] Initializing secure connection...</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // CONFIG - MUST MATCH INDEX.HTML
        window.appId = '117144'; 
        window.ws = null;
        window.isBotRunning = false;
        window.activeToken = null;
        window.startingBalance = 0;
        window.currentBalance = 0;
        window.netProfit = 0;
        window.stats = { wins: 0, losses: 0 };
        window.activeContracts = new Set();
        window.executionLock = false;

        function log(msg, type = 'INFO') {
            const logArea = document.getElementById('log-area');
            const entry = document.createElement('div');
            const now = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="text-gray-600 mr-2">[${now}]</span> <span>${msg}</span>`;
            if (type === 'WIN') entry.className = 'text-green-400 font-bold';
            if (type === 'LOSS') entry.className = 'text-red-400 font-bold';
            logArea.prepend(entry);
        }

        // AUTO-AUTH LOGIC
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token') || localStorage.getItem('derivToken');
            
            if (token) {
                window.activeToken = token;
                connect(token);
            } else {
                log('❌ No token found. Redirecting to login...', 'ERROR');
                setTimeout(() => window.location.href = 'index.html', 2000);
            }
        });

        function connect(token) {
            window.ws = new WebSocket(`wss://ws.derivws.com/stocks/v3?app_id=${window.appId}`);
            
            window.ws.onopen = () => {
                window.ws.send(JSON.stringify({ authorize: token }));
            };

            window.ws.onmessage = (msg) => {
                const data = JSON.parse(msg.data);
                if (data.error) {
                    log('❌ Auth Error: ' + data.error.message);
                    return;
                }

                if (data.msg_type === 'authorize') {
                    window.startingBalance = parseFloat(data.authorize.balance);
                    document.getElementById('status-badge').textContent = 'Connected';
                    document.getElementById('status-badge').className = 'ml-3 px-3 py-1 rounded-full bg-green-600 text-white';
                    log('✅ Securely Authenticated', 'SUCCESS');
                    window.ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
                }

                if (data.msg_type === 'balance') {
                    window.currentBalance = parseFloat(data.balance.balance);
                    window.netProfit = window.currentBalance - window.startingBalance;
                    document.getElementById('metricAccountBalance').textContent = `$${window.currentBalance.toFixed(2)}`;
                    document.getElementById('metricTotalProfit').textContent = `$${window.netProfit.toFixed(2)}`;
                }
                
                // Tick stream for UI
                if (data.msg_type === 'tick') {
                    document.getElementById('price-display').textContent = data.tick.quote;
                }
            };
        }

        function toggleBot() {
            if (!window.isBotRunning) {
                window.isBotRunning = true;
                document.getElementById('mainActionButton').textContent = 'Stop Bot';
                document.getElementById('mainActionButton').className = 'w-full bg-red-600 hover:bg-red-500 text-white font-black py-4 rounded-2xl';
                log('▶️ Trading Started');
                // Basic tick subscription
                window.ws.send(JSON.stringify({ ticks: document.getElementById('marketSelect').value, subscribe: 1 }));
            } else {
                window.isBotRunning = false;
                document.getElementById('mainActionButton').textContent = 'Start Bot';
                document.getElementById('mainActionButton').className = 'w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl';
                log('⏹️ Trading Stopped');
            }
        }

        function logout() {
            localStorage.removeItem('derivToken');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
